#include <iostream>
#include <openssl/aes.h>
#include <openssl/rand.h>

void printData(const std::string &title, const unsigned char *data, int len) {
    std::cout << title;
    for (int i = 0; i < len; i++) {
        printf("%02x", data[i]);
    }
    std::cout << std::endl;
}

int main() {
    // ???????? ??????
    unsigned char key[AES_BLOCK_SIZE];   // 16 ???? (128 ???)
    unsigned char iv[AES_BLOCK_SIZE];    // ?????? ?????????????
    unsigned char inputText[] = "Hello, AES Encryption!"; // ?????? ??? ??????????
    unsigned char encryptedText[128];    // ????????????? ?????
    unsigned char decryptedText[128];    // ?????????????? ?????

    // ????????? ?????????? ????? ? IV
    if (!RAND_bytes(key, sizeof(key)) || !RAND_bytes(iv, sizeof(iv))) {
        std::cerr << "?????? ????????? ????? ??? IV" << std::endl;
        return 1;
    }

    // ????? ????? ? IV
    printData("????: ", key, AES_BLOCK_SIZE);
    printData("IV: ", iv, AES_BLOCK_SIZE);

    // ??????? ????????? AES
    AES_KEY encryptKey, decryptKey;

    // ????????? ????? ??? ?????????? ? ???????????
    AES_set_encrypt_key(key, 128, &encryptKey);
    AES_set_decrypt_key(key, 128, &decryptKey);

    // ??????????
    AES_cbc_encrypt(inputText, encryptedText, sizeof(inputText), &encryptKey, iv, AES_ENCRYPT);

    // ????? ?????????????? ??????
    printData("????????????? ?????: ", encryptedText, sizeof(inputText));

    // ???????????
    AES_cbc_encrypt(encryptedText, decryptedText, sizeof(inputText), &decryptKey, iv, AES_DECRYPT);

    // ????? ??????????????? ??????
    std::cout << "?????????????? ?????: " << decryptedText << std::endl;

    return 0;
}
